<?php

require_once('db.php');


$fn2hash_files['3.3.4']['gog']['windows'] = 'exec/3.3.4/gog/windows/stellaris-3.3.4-gog-windows.csv';
$fn2hash_files['3.3.4']['steam']['windows'] = 'exec/3.3.4/steam/windows/stellaris-3.3.4-steam-windows.csv';
$addr_to_symbol_files['3.3.4']['gog']['windows'] = 'exec/3.3.4/gog/windows/func_addr.txt';



$fn2hash_files['3.4.2']['gog']['windows'] = 'exec/3.4.2/stellaris-3.4.2-gog-windows.csv';
$fn2hash_files['3.4.2']['steam']['windows'] = 'exec/3.4.2/stellaris-3.4.2-steam-windows.csv';
$addr_to_symbol_files['3.4.2']['gog']['windows'] = 'exec/3.4.2/func_addr_stellaris_3.4.2_gog_windows.txt';


$fn2hash_files['3.4.3']['gog']['windows'] = 'exec/3.4.3/gog/windows/fn2hash.csv';
$fn2hash_files['3.4.3']['steam']['windows'] = 'exec/3.4.3/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.4.3']['gog']['windows'] = 'exec/3.4.3/gog/windows/func_addr.txt';

$fn2hash_files['3.4.4']['gog']['windows'] = 'exec/3.4.4/gog/windows/fn2hash.csv';
$fn2hash_files['3.4.4']['steam']['windows'] = 'exec/3.4.4/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.4.4']['gog']['windows'] = 'exec/3.4.4/gog/windows/func_addr.txt';

$fn2hash_files['3.4.5']['gog']['windows'] = 'exec/3.4.5/gog/windows/fn2hash.csv';
$fn2hash_files['3.4.5']['steam']['windows'] = 'exec/3.4.5/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.4.5']['gog']['windows'] = 'exec/3.4.5/gog/windows/func_addr.txt';

$fn2hash_files['3.5.1']['gog']['windows'] = 'exec/3.5.1/gog/windows/fn2hash.csv';
$fn2hash_files['3.5.1']['steam']['windows'] = 'exec/3.5.1/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.5.1']['gog']['windows'] = 'exec/3.5.1/gog/windows/func_addr.txt';

$fn2hash_files['3.5.2']['gog']['windows'] = 'exec/3.5.2/gog/windows/fn2hash.csv';
$fn2hash_files['3.5.2']['steam']['windows'] = 'exec/3.5.2/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.5.2']['gog']['windows'] = 'exec/3.5.2/gog/windows/func_addr.txt';

$fn2hash_files['3.5.3']['gog']['windows'] = 'exec/3.5.3/gog/windows/fn2hash.csv';
$fn2hash_files['3.5.3']['steam']['windows'] = 'exec/3.5.3/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.5.3']['gog']['windows'] = 'exec/3.5.3/gog/windows/func_addr.txt';


$fn2hash_files['3.6.0']['gog']['windows'] = 'exec/3.6.0/gog/windows/fn2hash.csv';
$fn2hash_files['3.6.0']['steam']['windows'] = 'exec/3.6.0/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.6.0']['gog']['windows'] = 'exec/3.6.0/gog/windows/func_addr.txt';

$fn2hash_files['3.6.1']['gog']['windows'] = 'exec/3.6.1/gog/windows/fn2hash.csv';
$fn2hash_files['3.6.1']['steam']['windows'] = 'exec/3.6.1/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.6.1']['gog']['windows'] = 'exec/3.6.1/gog/windows/func_addr.txt';

$fn2hash_files['3.7.2']['gog']['windows'] = 'exec/3.7.2/gog/windows/fn2hash.csv';
$fn2hash_files['3.7.2']['steam']['windows'] = 'exec/3.7.2/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.7.2']['gog']['windows'] = 'exec/3.7.2/gog/windows/func_addr.txt';

$fn2hash_files['3.7.3']['gog']['windows'] = 'exec/3.7.3/gog/windows/fn2hash.csv';
$fn2hash_files['3.7.3']['steam']['windows'] = 'exec/3.7.3/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.7.3']['gog']['windows'] = 'exec/3.7.3/gog/windows/func_addr.txt';

$fn2hash_files['3.7.4']['gog']['windows'] = 'exec/3.7.4/gog/windows/fn2hash.csv';
$fn2hash_files['3.7.4']['steam']['windows'] = 'exec/3.7.4/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.7.4']['gog']['windows'] = 'exec/3.7.4/gog/windows/func_addr.txt';

$fn2hash_files['3.8.1']['gog']['windows'] = 'exec/3.8.1/gog/windows/fn2hash.csv';
$fn2hash_files['3.8.1']['steam']['windows'] = 'exec/3.8.1/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.8.1']['gog']['windows'] = 'exec/3.8.1/gog/windows/func_addr.txt';


$fn2hash_files['3.8.2']['gog']['windows'] = 'exec/3.8.2/gog/windows/fn2hash.csv';
$fn2hash_files['3.8.2']['steam']['windows'] = 'exec/3.8.2/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.8.2']['gog']['windows'] = 'exec/3.8.2/gog/windows/func_addr.txt';

$fn2hash_files['3.8.3']['gog']['windows'] = 'exec/3.8.3/gog/windows/fn2hash.csv';
$fn2hash_files['3.8.3']['steam']['windows'] = 'exec/3.8.3/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.8.3']['gog']['windows'] = 'exec/3.8.3/gog/windows/func_addr.txt';

$fn2hash_files['3.8.4']['gog']['windows'] = 'exec/3.8.4/gog/windows/fn2hash.csv';
$fn2hash_files['3.8.4']['steam']['windows'] = 'exec/3.8.4/steam/windows/fn2hash.csv';
$addr_to_symbol_files['3.8.4']['gog']['windows'] = 'exec/3.8.4/gog/windows/func_addr.txt';



$fn2hash_fields = array();
$fn2hash_fields['executable_md5'] = 0;
$fn2hash_fields['fn_addr'] = 1;
$fn2hash_fields['num_basic_blocks'] = 2;
$fn2hash_fields['num_basic_blocks_in_cfg'] = 3;
$fn2hash_fields['num_instructions'] = 4;
$fn2hash_fields['num_bytes'] = 5;
$fn2hash_fields['exact_hash'] = 6;
$fn2hash_fields['pic_hash'] = 7;
$fn2hash_fields['composite_pic_hash'] = 8;
$fn2hash_fields['mnemonic_hash'] = 9;
$fn2hash_fields['mnemonic_count_hash'] = 10;
$fn2hash_fields['mnemonic_category_hash'] = 11;
$fn2hash_fields['mnemonic_category_count_hash'] = 12;
$fn2hash_fields['mnemonic_count_string'] = 13;
$fn2hash_fields['mnemonic_category_count_string'] = 14;

function find_match_in_fn2hash_csv($match_value, $filename, $field){
	global $fn2hash_fields;
	if(is_file($filename. '.zip')){
		$fh = fopen('zip://' . $filename . '.zip#' . basename($filename), 'r');
	}else{
		$fh = fopen($filename, 'r');
	}
	//EDDE426BD489F193063C72F919570068,140001000,2,2,2,12,6D002D7404F15D44E400FE4399951F1E,CB6D41FBDBBE2BF61786A4844D77941F,DE36B7303D0BEF824ACAC26665DE06F1,CAD34B2407A60CA0636A4BB65AFA040D,5756D8E5ED353AEC99DB0BDCD90FCF9E,D7F267298315A090757E01A76E5087ED,716C82E6AC88D7C5182B49E1A6E9406D,JMP:1;LEA:1,BR:1;CMP:0;CRYPTO:0;FLT:0;I/O:0;LOGIC:0;MATH:1;NOP:0;SIMD:0;STR:0;SYS:0;UNCAT:0;VMM:0;XFER:0


	while(!feof($fh)){
		$line = fgets($fh);
		if(trim($line) == "") continue;
		$e = explode(',', $line);
		if($field == $fn2hash_fields['fn_addr']){
			$e[$field] = @hexdec($e[$field]);
		}
		if($e[$field] == $match_value){
			$r = array();
			foreach($fn2hash_fields as $key => $position){
				$r[$key] = $e[$position];
			}
			return $r;
		}
		
	}

	return null;
}

function find_match_in_fn2hash_db($version, $addr, $hash_type){
	global $dbh;
	$query = pg_query_params(
	'with steam_windows as ('.
	"select id from versions where version = $1 and platform = 'steam' and os = 'windows'".
	'), gog_windows as ('.
	"select id from versions where version = $1 and platform = 'gog' and os = 'windows'".
	') '.
	'select pic_fn2.addr, pic_fn2.num_instructions, pic_fn2.num_bytes, pic_symbol.symbol '.
        '  from fn2hash source_fn2 '.
	'   left join fn2hash pic_fn2 on ( pic_fn2.'.$hash_type.' = source_fn2.'.$hash_type.' and pic_fn2.version_id in (select id from gog_windows) )'.
	'   left join symbol_addr pic_symbol_addr on (pic_fn2.addr = pic_symbol_addr.addr and pic_symbol_addr.version_id in (select id from gog_windows) )'.
	'   left join symbols pic_symbol on (pic_symbol.id = pic_symbol_addr.symbol_id)'.
	'  where source_fn2.version_id in ( select id from steam_windows) '.
	'    and source_fn2.addr = $2', 
	array($version, $addr));

	$result = pg_fetch_all($query);
	if(is_array($result)){
		return pg_fetch_all($query)[0];
	}else{
		return null;
	}

}


function find_match_in_addr_to_symbol($addr, $filename){
	$fh = fopen($filename, 'r');
	
	while(!feof($fh)){
		$line = fgets($fh);
		if(trim($line) == "") continue;
		$e = explode('###', $line);
		if(hexdec($e[0]) == hexdec($addr)){
			return $e;
		}
	}

	return null;
}
		

