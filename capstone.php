<?php

require_once('db.php');

$exec_file['3.3.4']['steam']['windows'] = 'exec/3.3.4/steam/windows/stellaris.exe';
$exec_file['3.3.4']['gog']['windows'] = 'exec/3.3.4/gog/windows/stellaris.exe';
$objdump['3.3.4']['steam']['windows']['exports'] = 'exec/3.3.4/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.3.4']['steam']['windows']['functions'] = 'exec/3.3.4/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.3.4']['gog']['windows'] = 'exec/3.3.4/gog/windows/func_sigs.txt';
$exec_addr['3.3.4']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.3.4']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.4.2']['steam']['windows'] = 'exec/3.4.2/steam/windows/stellaris.exe';
$exec_file['3.4.2']['gog']['windows'] = 'exec/3.4.2/gog/windows/stellaris.exe';
$objdump['3.4.2']['steam']['windows']['exports'] = 'exec/3.4.2/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.4.2']['steam']['windows']['functions'] = 'exec/3.4.2/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.4.2']['gog']['windows'] = 'exec/3.4.2/func_sigs.txt';
$exec_addr['3.4.2']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.4.2']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.4.3']['steam']['windows'] = 'exec/3.4.3/steam/windows/stellaris.exe';
$exec_file['3.4.3']['gog']['windows'] = 'exec/3.4.3/gog/windows/stellaris.exe';
$objdump['3.4.3']['steam']['windows']['exports'] = 'exec/3.4.3/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.4.3']['steam']['windows']['functions'] = 'exec/3.4.3/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.4.3']['gog']['windows'] = 'exec/3.4.3/gog/windows/func_sigs.txt';
$exec_addr['3.4.3']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.4.3']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.4.4']['steam']['windows'] = 'exec/3.4.4/steam/windows/stellaris.exe';
$exec_file['3.4.4']['gog']['windows'] = 'exec/3.4.4/gog/windows/stellaris.exe';
$objdump['3.4.4']['steam']['windows']['exports'] = 'exec/3.4.4/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.4.4']['steam']['windows']['functions'] = 'exec/3.4.4/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.4.4']['gog']['windows'] = 'exec/3.4.4/gog/windows/func_sigs.txt';
$exec_addr['3.4.4']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.4.4']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.4.5']['steam']['windows'] = 'exec/3.4.5/steam/windows/stellaris.exe';
$exec_file['3.4.5']['gog']['windows'] = 'exec/3.4.5/gog/windows/stellaris.exe';
$objdump['3.4.5']['steam']['windows']['exports'] = 'exec/3.4.5/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.4.5']['steam']['windows']['functions'] = 'exec/3.4.5/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.4.5']['gog']['windows'] = 'exec/3.4.5/gog/windows/func_sigs.txt';
$exec_addr['3.4.5']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.4.5']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.5.1']['steam']['windows'] = 'exec/3.5.1/steam/windows/stellaris.exe';
$exec_file['3.5.1']['gog']['windows'] = 'exec/3.5.1/gog/windows/stellaris.exe';
$objdump['3.5.1']['steam']['windows']['exports'] = 'exec/3.5.1/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.5.1']['steam']['windows']['functions'] = 'exec/3.5.1/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.5.1']['gog']['windows'] = 'exec/3.5.1/gog/windows/func_sigs.txt';
$exec_addr['3.5.1']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.5.1']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.5.2']['steam']['windows'] = 'exec/3.5.2/steam/windows/stellaris.exe';
$exec_file['3.5.2']['gog']['windows'] = 'exec/3.5.2/gog/windows/stellaris.exe';
$objdump['3.5.2']['steam']['windows']['exports'] = 'exec/3.5.2/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.5.2']['steam']['windows']['functions'] = 'exec/3.5.2/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.5.2']['gog']['windows'] = 'exec/3.5.2/gog/windows/func_sigs.txt';
$exec_addr['3.5.2']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.5.2']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.5.3']['steam']['windows'] = 'exec/3.5.3/steam/windows/stellaris.exe';
$exec_file['3.5.3']['gog']['windows'] = 'exec/3.5.3/gog/windows/stellaris.exe';
$objdump['3.5.3']['steam']['windows']['exports'] = 'exec/3.5.3/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.5.3']['steam']['windows']['functions'] = 'exec/3.5.3/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.5.3']['gog']['windows'] = 'exec/3.5.3/gog/windows/func_sigs.txt';
$exec_addr['3.5.3']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.5.3']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.6.0']['steam']['windows'] = 'exec/3.6.0/steam/windows/stellaris.exe';
$exec_file['3.6.0']['gog']['windows'] = 'exec/3.6.0/gog/windows/stellaris.exe';
$objdump['3.6.0']['steam']['windows']['exports'] = 'exec/3.6.0/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.6.0']['steam']['windows']['functions'] = 'exec/3.6.0/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.6.0']['gog']['windows'] = 'exec/3.6.0/gog/windows/func_sigs.txt';
$exec_addr['3.6.0']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.6.0']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.6.1']['steam']['windows'] = 'exec/3.6.1/steam/windows/stellaris.exe';
$exec_file['3.6.1']['gog']['windows'] = 'exec/3.6.1/gog/windows/stellaris.exe';
$objdump['3.6.1']['steam']['windows']['exports'] = 'exec/3.6.1/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.6.1']['steam']['windows']['functions'] = 'exec/3.6.1/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.6.1']['gog']['windows'] = 'exec/3.6.1/gog/windows/func_sigs.txt';
$exec_addr['3.6.1']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.6.1']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.7.2']['steam']['windows'] = 'exec/3.7.2/steam/windows/stellaris.exe';
$exec_file['3.7.2']['gog']['windows'] = 'exec/3.7.2/gog/windows/stellaris.exe';
$objdump['3.7.2']['steam']['windows']['exports'] = 'exec/3.7.2/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.7.2']['steam']['windows']['functions'] = 'exec/3.7.2/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.7.2']['gog']['windows'] = 'exec/3.7.2/gog/windows/func_sigs.txt';
$exec_addr['3.7.2']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.7.2']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.7.3']['steam']['windows'] = 'exec/3.7.3/steam/windows/stellaris.exe';
$exec_file['3.7.3']['gog']['windows'] = 'exec/3.7.3/gog/windows/stellaris.exe';
$objdump['3.7.3']['steam']['windows']['exports'] = 'exec/3.7.3/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.7.3']['steam']['windows']['functions'] = 'exec/3.7.3/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.7.3']['gog']['windows'] = 'exec/3.7.3/gog/windows/func_sigs.txt';
$exec_addr['3.7.3']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.7.3']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.7.4']['steam']['windows'] = 'exec/3.7.4/steam/windows/stellaris.exe';
$exec_file['3.7.4']['gog']['windows'] = 'exec/3.7.4/gog/windows/stellaris.exe';
$objdump['3.7.4']['steam']['windows']['exports'] = 'exec/3.7.4/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.7.4']['steam']['windows']['functions'] = 'exec/3.7.4/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.7.4']['gog']['windows'] = 'exec/3.7.4/gog/windows/func_sigs.txt';
$exec_addr['3.7.4']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.7.4']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.8.1']['steam']['windows'] = 'exec/3.8.1/steam/windows/stellaris.exe';
$exec_file['3.8.1']['gog']['windows'] = 'exec/3.8.1/gog/windows/stellaris.exe';
$objdump['3.8.1']['steam']['windows']['exports'] = 'exec/3.8.1/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.8.1']['steam']['windows']['functions'] = 'exec/3.8.1/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.8.1']['gog']['windows'] = 'exec/3.8.1/gog/windows/func_sigs.txt';
$exec_addr['3.8.1']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.8.1']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.8.2']['steam']['windows'] = 'exec/3.8.2/steam/windows/stellaris.exe';
$exec_file['3.8.2']['gog']['windows'] = 'exec/3.8.2/gog/windows/stellaris.exe';
$objdump['3.8.2']['steam']['windows']['exports'] = 'exec/3.8.2/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.8.2']['steam']['windows']['functions'] = 'exec/3.8.2/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.8.2']['gog']['windows'] = 'exec/3.8.2/gog/windows/func_sigs.txt';
$exec_addr['3.8.2']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.8.2']['steam']['windows']['offset'] = -0xc00;


$exec_file['3.8.3']['steam']['windows'] = 'exec/3.8.3/steam/windows/stellaris.exe';
$exec_file['3.8.3']['gog']['windows'] = 'exec/3.8.3/gog/windows/stellaris.exe';
$objdump['3.8.3']['steam']['windows']['exports'] = 'exec/3.8.3/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.8.3']['steam']['windows']['functions'] = 'exec/3.8.3/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.8.3']['gog']['windows'] = 'exec/3.8.3/gog/windows/func_sigs.txt';
$exec_addr['3.8.3']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.8.3']['steam']['windows']['offset'] = -0xc00;

$exec_file['3.8.4']['steam']['windows'] = 'exec/3.8.4/steam/windows/stellaris.exe';
$exec_file['3.8.4']['gog']['windows'] = 'exec/3.8.4/gog/windows/stellaris.exe';
$objdump['3.8.4']['steam']['windows']['exports'] = 'exec/3.8.4/steam/windows/stellaris.exe.objdump.exports.parseable';
$objdump['3.8.4']['steam']['windows']['functions'] = 'exec/3.8.4/steam/windows/stellaris.exe.objdump.functions';
$func_sigs['3.8.4']['gog']['windows'] = 'exec/3.8.4/gog/windows/func_sigs.txt';
$exec_addr['3.8.4']['steam']['windows']['base'] = 0x140000000;
$exec_addr['3.8.4']['steam']['windows']['offset'] = -0xc00;



function load_known_symbols($filename){
	$result = array();

	if(is_file($filename. '.zip')){
		$fh = fopen('zip://' . $filename . '.zip#' . basename($filename), 'r');
        }else{
                $fh = fopen($filename, 'r');
	}

	while(!feof($fh)){
		$line = fgets($fh);
		if(trim($line) == "") continue;
		$e = explode(' ', $line);
		$result[$e[1]] = $e[0];
	}
	fclose($fh);

	return $result;
}



function load_known_functions($filename){
	$result = array();

	if(is_file($filename. '.zip')){
                $fh = fopen('zip://' . $filename . '.zip#' . basename($filename), 'r');
        }else{
                $fh = fopen($filename, 'r');
        }

	//Two header lines
	fgets($fh); 
	fgets($fh); 


	while(!feof($fh)){
		$line = fgets($fh);
		$e = explode("\t", $line);
		if(!isset($e[1])) continue;
		$e2 = explode(" ", $e[1]);
		if(!isset($e2[1])) continue;
	
		$result[] = array(hexdec($e2[0]), hexdec($e2[1]));
	}

	fclose($fh);
	return $result;
}
function load_func_sigs($filename){
        $func_sigs_arr = array();

	if(is_file($filename. '.zip')){
                $fh = fopen('zip://' . $filename . '.zip#' . basename($filename), 'r');
        }else{
                $fh = fopen($filename, 'r');
        }

        if(!$fh){
                die("Fatal error: unable to open file");
        }
        while(!feof($fh)){
                $line = fgets($fh);
                $func_sigs_arr[] = $line;
        }
        fclose($fh);

	return $func_sigs_arr;
}

function parse_stack($filename){
        $file = explode("\n", file_get_contents($filename));
        $attr = array();

        for($i = 0; $i < 3; $i++){
                $line = explode(": ", $file[$i]);
                $attr[trim($line[0])] = trim($line[1]);
        }

        $exception = $file[4];

        $stack = array();
        for($i = 7; $i < count($file); $i++){
                if(trim($file[$i]) === ""){
                        continue;
                }

                $line = $file[$i];
                $matches = array();
                $re = '/^\s*(?<frame>\d+)\s+(?<module>[^\s]+)\s+(?<symbol>.+?)\s\((?<offset>[+-]\s+[0-9-]+)\)\s*$/';
		preg_match_all($re, $line, $matches, PREG_SET_ORDER, 0);
		if($matches == null){
			continue;
		}
                $matches = $matches[0];

		$stack[] = array("frame"=> $matches['frame'], "module" => $matches['module'], "symbol" => $matches['symbol'], "offset" => $matches['offset']);
		
        }

	return array('stack' => $stack, 'attr' => $attr, 'exception' => $exception);
}

function dedupe_parsed_stack($stack){
	$loop_detect = array();
	foreach($stack as $key => $frame){
		if(!key_exists($frame['module'], $loop_detect)){
			$loop_detect[$frame['module']] = array();
		}

		$frame_key = $frame['symbol'] . $frame['offset'];
		if(!key_exists($frame['symbol'] . $frame['offset'], $loop_detect[$frame['module']])){
			$loop_detect[$frame['module']][$frame_key] = 0;
		}
		
		$loop_detect[$frame['module']][$frame_key]++;
	}

	$seen_frames = array();
	$new_stack = array();
	foreach($stack as $key => $frame){
		$frame_key = $frame['symbol'] . $frame['offset'];
		

		$frame['loop_count'] = $loop_detect[$frame['module']][$frame_key];
		if($loop_detect[$frame['module']][$frame_key] >= 5){
			if(!key_exists($frame_key, $seen_frames)){
				$seen_frames[$frame_key] = True;
				$new_stack[] = $frame;
			}
		}else{
			$new_stack[] = $frame;
		}

	}

	return $new_stack;
}

function init_capstone(){
	$cs = cs_open(CS_ARCH_X86, CS_MODE_64+CS_MODE_LITTLE_ENDIAN);
	cs_option($cs, CS_OPT_DETAIL, CS_OPT_ON);
	cs_option($cs, CS_OPT_SKIPDATA, CS_OPT_OFF);

	return $cs;
}

function find_known_symbol($module, $symbol){
	global $known_symbols;
	$matching_symbol = Null;
	$matching_addr = Null;

	//TODO: Doesn't use module...

	foreach($known_symbols as $known_symbol => $known_address){
		if(stristr($known_symbol, $symbol)){
			$matching_symbol = $known_symbol;
			$matching_addr = hexdec($known_address);
			break;
		}
	}

	return array('symbol' => $matching_symbol, 'addr' => $matching_addr);
}



function parse_exception_offset($offset_str, $addr, $base){
	$e = explode(' ', $offset_str);
	$real_offset = $addr+$base;

	if($e[0] == '+'){
		$real_offset += (int)trim($e[1]);
	}elseif($e[0] == "-"){
		$real_offset -= (int)trim($e[1]);
	}else{
		$real_offset = Null;
	}

	return $real_offset;
}


function  find_fn_start_end($addr){
        global $dbh, $game_version;

        $query = pg_query_params("select start_addr,end_addr from objdump_function where start_addr <= $1 and end_addr >= $1 and version_id in (select id from versions where version = $2 and os= 'windows' and platform='steam')", array($addr, $game_version));
	$result = pg_fetch_all($query);

	$max_size = 0;
	$ret = null;
	if(!is_array($result)){
		return array('start' => $addr, 'end' => $addr, 'addr' => $addr);
	}
	foreach($result as $key => $data){
		$start = $data['start_addr'];
		$end = $data['end_addr'];
		if($end-$start > $max_size){
			$max_size = $end-$start;
                	$ret =  array(
				'start' => $start, 
        		        'end' => $end, 
	                	'addr' => $addr, 
		                'relative_start' => $addr-$start, 
		                'relative_end' => $addr-$end, 
		                'size' => $end-$start,
			);
		}
	}

	return $ret;
	
}

/*
function find_fn_start_end($addr){
	global $known_functions;
	$start = $addr;
	$end = $addr;

	foreach($known_functions as $key => $data){
        	if($addr > $data[0] && $addr < $data[1]){
                	$start = $data[0];
                        $end = $data[1];
                        break;
               	}
        }

	return array(
		'start' => $start, 
		'end' => $end, 
		'addr' => $addr, 
		'relative_start' => $addr-$start, 
		'relative_end' => $addr-$end, 
		'size' => $end-$start,
	);
}
*/
function capstone_get_disasm($cs, $filename, $offset, $size = 50){
	$fh = fopen($filename, 'rb');
	fseek($fh, ($offset));
	$buf = fread($fh, $size);
	fclose($fh);
	
	return cs_disasm($cs, $buf, 0, 0);
}




